var kmaster = function () { function t() { } function e() { $(".progress .bar").progressbar({ transition_delay: 500 }); var t = $(".js-loading-bar"); t.find(".bar"); t.modal("show"), setTimeout(function () { t.modal("hide") }, 1200) } function n() { window.templates = {}, window.templates.common = Handlebars.compile($("#control-customize-template").html()), window.templates.textbox = Handlebars.compile($("#textbox-template").html()), window.templates.passwordbox = Handlebars.compile($("#textbox-template").html()), window.templates.combobox = Handlebars.compile($("#combobox-template").html()), window.templates.selectmultiplelist = Handlebars.compile($("#combobox-template").html()), window.templates.radiogroup = Handlebars.compile($("#combobox-template").html()), window.templates.checkboxgroup = Handlebars.compile($("#combobox-template").html()), window.templates.text = Handlebars.compile($("#text-template").html()), window.templates.date = Handlebars.compile($("#date-template").html()), window.templates.form = Handlebars.compile($("#form-template").html()) } function a() { $(".droppedFields").droppable({ activeClass: "activeDroppable", hoverClass: "hoverDroppable", accept: ":not(.ui-sortable-helper)", drop: function (e, n) { if (0 == t.mcurrentEntityDefID) return void $.msgBox({ title: "Master / Entity", content: "请先选择表单记录，再拖动控件！", type: "info" }); var a = n.draggable; a = $(n.draggable).find(".modele").clone(), a.removeClass("modele"), a.removeClass("selectorField"), a.addClass("droppedField"), a[0].id = "CTRL-DIV-" + o(), a.appendTo(this), a.click(function () { var t = $(this), e = t.find("[class*=ctrl]")[0], n = $.trim(e.className.match("ctrl-.*")[0].split(" ")[0].split("-")[1]); l(n, this.id) }) } }), $(".droppedFields").mouseenter(function () { t.tableToDelete = this, $("#divDeleteTable").show(), $("#divDeleteTable").position({ my: "right top", at: "right top", of: $(this).parent().children().last() }) }), $(".droppedFields").mouseleave(function () { $("#divDeleteTable").hide() }), $(".droppedField").click(function () { var t = $(this), e = t.find("[class*=ctrl]")[0], n = $.trim(e.className.match("ctrl-.*")[0].split(" ")[0].split("-")[1]); l(n, this.id) }) } function o() { var e = 1e3; return $(".droppedField").each(function (t, n) { var a = $(n).attr("id").split("-")[2]; parseInt(a) > parseInt(e) && (e = a) }), t.mctrlIndex = parseInt(e) + 1, t.mctrlIndex } function i() { $(".selectorField").draggable({ helper: "clone", stack: "div", cursor: "move", cancel: null }) } function l(t, e) { var n = {}, a = window.templates[t]; "undefined" == typeof a && (a = function () { return "" }); var o = $("#" + e).find(".control-label").text(), i = { header: o, content: a(n), type: t, forCtrl: e, display: "block" }, l = window.templates.common(i) + ""; $("[name=customization_modal]").remove(), $('<div id="customization_modal" name="customization_modal" class="modal hide fade" />').append(l).modal("show"), setTimeout(function () { fieldPopup.popupControl(t, e) }, 300) } function r() { $("#divDeleteTable").hide(), $("#divDeleteTable").mouseenter(function () { $("#divDeleteTable").show() }), $("#sliderNumberColumn").slider({ min: 1, max: 4, value: 1, slide: function (t, e) { $("#numberColumn").html(e.value) } }), $("#numberColumn").html($("#sliderNumberColumn").slider("value")), $("#selected-content").sortable({ cancel: null, start: function (t, e) { $("#divDeleteTable").hide() } }).disableSelection() } return t.mcurrentEntityDefID = 0, t.mctrlIndex = 1001, t.moutputHtmlPageContent = "", t.docReady = function () { e(), n(), a(), i(), r() }, t.createEntityDef = function () { t.mcurrentEntityDefID = 0; var e = {}; e.label = "", e.name = "", e.desc = ""; var n = window.templates.form; "undefined" == typeof n && (n = function () { return "" }); var a = { header: "表单定义", content: n(e), display: "block" }; $("[name=custom_form_modal]").remove(), $('<div id="custom_form_modal" name="custom_form_modal" class="modal hide fade" />').append(a.content).modal("show") }, t.popupEntityDef = function () { var e = {}; return 0 == t.mcurrentEntityDefID ? !1 : void jshelper.ajaxGet("/smd/api/eavdata/GetEntityDefByID/" + t.mcurrentEntityDefID, null, function (t) { if (1 == t.Status) { var n = t.Entity; e.label = n.EntityTitle, e.name = n.EntityName, e.desc = n.Description; var a = window.templates.form; "undefined" == typeof a && (a = function () { return "" }); var o = { header: "表单定义", content: a(e), display: "block" }; $("[name=custom_form_modal]").remove(), $('<div id="custom_form_modal" name="custom_form_modal" class="modal hide fade" />').append(o.content).modal("show") } else $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) }, t.deleteTable = function () { t.tableToDelete && $.msgBox({ title: "Are You Sure", content: "确定要删除表格吗?", type: "confirm", buttons: [{ value: "Yes" }, { value: "Cancel" }], success: function (e) { if ("Yes" == e) { for (var n = $(t.tableToDelete).parent().find("input[class=hiddenAttributeEntity]"), a = new Array(n.length), o = 0; o < n.length; o++) a[o] = $.parseJSON(n[o].value); $("body").append($("#divDeleteTable")), $(t.tableToDelete).parent().remove(), t.tableToDelete = null, $("#divDeleteTable").hide(); var i = $("#selected-content")[0].outerHTML, l = { ID: t.mcurrentEntityDefID, TemplateContent: i, HTMLContent: "" }, r = {}; return r.EntityDef = l, r.EntityAttributeList = a, void jshelper.ajaxPost("/smd/api/eavdata/DeleteAttributeWithTemplate", JSON.stringify(r), function (t) { 1 == t.Status ? $.msgBox({ title: "Master / Table", content: "表格已经删除，并且模板内容已经更新！", type: "info" }) : $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) } } }) }, t.generateHTMLContent = function () { var t = $("#selected-content").clone(); t.find("div").each(function (t, e) { var n = $(e); n.removeClass("draggableField ui-draggable well ui-droppable ui-sortable") }); var e = $("#txtFormTitle")[0].value; (void 0 == e || "" == e) && (e = "自定义表单示例"), t.find("#form-title-div").remove(); var n = t.html(); return n }, t.previewForm = function () { var e = t.validateInput(); 1 == e && window.open("/smd/preview/index/" + t.mcurrentEntityDefID) }, t.showAdjustDialog = function () { $("#dialog-form-number-column").modal("show").css("z-index", "1500") }, t.validateInput = function () { var t = !0, e = $("#selected-content").find("[class=hiddenAttributeEntity]"); return e.each(function (e, n) { if (!n.value || "" == n.value) { t = !1; var a = $(n).parent().children(":first").text(); return $.msgBox({ title: "Master / Field", content: "字段信息需要填写完整并先保存, 当前字段:" + a, type: "alert" }), !1 } var o = $.parseJSON(n.value); return null == o.AttrName || "" == o.AttrName ? (t = !1, $.msgBox({ title: "Master / Field", content: "字段信息需要填写完整, 当前字段类型:" + o.type, type: "alert" }), !1) : void 0 }), t }, t.validatedSaveTemplate = function () { var e = t.validateInput(); 1 == e && eavManager.SaveTemplateWithHTMLContent() }, t }(), fieldManager = function () { function t() { } return t.popupControl = function (t, e) { var n = $("#eavForm"), a = $("#" + e), o = a.find(".hiddenMandatory"); if (null != o && o.length > 0) { var i = o[0]; n.find("[name=mandatory]").attr("checked", "true" == i.value), n.find("#pMandatory").show } else n.find("#pMandatory").hide(); n.find("[name=title]").val(a.find(".control-label").text()); var l = fieldPopup[t]; "undefined" != typeof l && l(t, e) }, t.updateAttribute = function (t, e) { function n(t) { var e = $("#" + t.forCtrl); e.find(".control-label").text(t.title); var n = e.find(".hiddenMandatory"); if (null != n && n.length > 0) { var o = n[0]; o.value = t.mandatory } var i = "" != e.find(".hiddenAttributeEntity").val() ? $.parseJSON(e.find(".hiddenAttributeEntity").val()) : {}; i.EntityDefID = kmaster.mcurrentEntityDefID, i.DivCtrlKey = t.forCtrl, i.AttrName = t.title, i.AttrDataType = t.datatype; var l = a(t.type); i.FieldInputType = l.fieldInputType, i.StorageType = l.storageType, i.Format = t.dateformat, i.IsMandatory = t.mandatory, i.ConditionKey = t.conditionkey, jshelper.ajaxPost("/smd/api/eavdata/SaveAttribute", JSON.stringify(i), function (n) { if (1 == n.Status) { var a = n.Entity; e.find(".hiddenAttributeEntity").attr("value", JSON.stringify(a)), t.code = a.AttrCode; var o = fieldChangeSave[t.type]; "undefined" != typeof o && o(t); var i = $("#selected-content")[0].outerHTML, l = { ID: kmaster.mcurrentEntityDefID, TemplateContent: i }; jshelper.ajaxPost("/smd/api/eavdata/SaveTemplateContent", JSON.stringify(l), function (t) { 1 == t.Status ? ($.msgBox({ title: "Master / Attribute", content: "字段和模板内容已经更新！", type: "info" }), $("[name=customization_modal]").modal("hide")) : $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) } else $.msgBox({ title: "Ooops", content: n.Message, type: "error", buttons: [{ value: "Ok" }] }) }) } function a(t) { var e = {}; return e.storageType = 1, "textbox" == t ? e.fieldInputType = 1 : "passwordbox" == t ? e.fieldInputType = 2 : "combobox" == t ? e.fieldInputType = 3 : "checkboxgroup" == t ? e.fieldInputType = 4 : "radiogroup" == t ? e.fieldInputType = 5 : "selectmultiplelist" == t ? e.fieldInputType = 6 : "date" == t ? e.fieldInputType = 7 : "text" == t ? e.fieldInputType = 8 : "btn" == t ? (e.fieldInputType = 16, e.storageType = 0) : "image" == t ? e.fieldInputType = 17 : $.msgBox({ title: "Ooops", content: "未知类型的控件！", type: "error", buttons: [{ value: "Ok" }] }), e } var o = $("#eavForm").find("input[name=title]").val(); if (null == o || "" == o) return $.msgBox({ title: "Master / Attribute", content: "字段标题需要输入！", type: "alert" }), !1; var i = {}, l = null; $("#eavForm").find("input, textarea, select").each(function (t, e) { l = "checkbox" == e.type ? e.checked : e.value, i[e.name] = l }), n(i) }, t.deleteField = function (t, e) { $.msgBox({ title: "Are You Sure", content: "确实要删除该控件吗？", type: "confirm", buttons: [{ value: "Yes" }, { value: "Cancel" }], success: function (t) { if ("Yes" == t) { var e = $("#eavForm").find("[name=forCtrl]").val(), n = $("#" + e), a = "" != n.find(".hiddenAttributeEntity").val() ? $.parseJSON(n.find(".hiddenAttributeEntity").val()) : null; if (n.remove(), null == a) return !1; var o = $("#selected-content")[0].outerHTML, i = { ID: kmaster.mcurrentEntityDefID, TemplateContent: o, HTMLContent: "" }, l = new Array; l[0] = a; var r = {}; r.EntityDef = i, r.EntityAttributeList = l, jshelper.ajaxPost("/smd/api/eavdata/DeleteAttributeWithTemplate", JSON.stringify(r), function (t) { 1 == t.Status ? ($.msgBox({ title: "Master / Attribute", content: "字段已经删除，并且模板内容已经更新！", type: "info" }), $("[name=customization_modal]").modal("hide")) : $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) } } }) }, t }(), fieldPopup = function () { function t() { } function e(t) { var e = null; return "" != t.find(".hiddenAttributeEntity").val() && (e = $.parseJSON(t.find(".hiddenAttributeEntity").val())), e } return t.popupControl = function (n, a) { var o = $("#eavForm"), i = $("#" + a), l = i.find(".hiddenMandatory"); if (null != l && l.length > 0) { var r = l[0]; o.find("[name=mandatory]").attr("checked", "true" == r.value), o.find("#pMandatory").show } else o.find("#pMandatory").hide(); o.find("[name=title]").val(i.find(".control-label").text()); var d = e(i); d && o.find("[name=conditionkey]").val(d.ConditionKey); var s = t[n]; "undefined" != typeof s && s(n, a, d) }, t.textbox = function (t, e, n) { var a = $("#eavForm"), o = $("#" + e), i = o.find("input[type=text]")[0]; a.find("[name=placeholder]").val(i.placeholder), null != n && a.find("[name=datatype]").val(n.AttrDataType) }, t.passwordbox = function (t, e, n) { var a = $("#eavForm"), o = $("#" + e), i = o.find("input[type=password]")[0]; a.find("[name=placeholder]").val(i.placeholder) }, t.combobox = function (t, e, n) { var a = $("#eavForm"), o = $("#" + e), i = o.find("select")[0], l = ""; $(i).find("option").each(function (t, e) { l += e.text + "\n" }), a.find("[name=options]").val($.trim(l)) }, t.selectmultiplelist = function (e, n, a) { t.combobox(e, n) }, t.radiogroup = function (t, e, n) { var a = $("#eavForm"), o = $("#" + e), i = "", l = o.find("div").find("span"); o.find("div").find("input"); l.each(function (t, e) { i += $(e).text() + "\n" }), a.find("[name=options]").val($.trim(i)) }, t.checkboxgroup = function (e, n, a) { t.radiogroup(e, n) }, t.btn = function (t, e, n) { var a = $("#eavForm"), o = $("#" + e), i = o.find("button")[0]; a.find("[name=title]").val($(i).text().trim()), $("#tLabel").hide() }, t.text = function (t, e, n) { var a = ($("#eavForm"), $("#" + e)); a.find(".ctrl-text")[0] }, t.date = function (t, e, n) { var a = $("#eavForm"), o = $("#" + e); o.find(".ctrl-date")[0]; a.find("[name=datatype]").val(kcommon.dataTypeDict.DATE), null != n && a.find("select[name=dateformat]").val(n.Format) }, t }(), fieldChangeSave = function () { function t() { } return t.textbox = function (t) { var e = $("#" + t.forCtrl), n = e.find("input[type=text]")[0]; n.placeholder = t.placeholder, n.name = t.code }, t.passwordbox = function (t) { var e = $("#" + t.forCtrl), n = e.find("input[type=password]")[0]; n.placeholder = t.placeholder, n.name = t.code }, t.combobox = function (t) { var e = $("#" + t.forCtrl), n = e.find("select")[0]; n.name = t.code, $(n).empty(), $(t.options.split("\n")).each(function (t, e) { $(n).append("<option>" + $.trim(e) + "</option>") }) }, t.checkboxgroup = function (t) { var e = $("#" + t.forCtrl), n = $(".selectorField .ctrl-checkboxgroup span")[0], a = $(".selectorField .ctrl-checkboxgroup input")[0], o = e.find(".ctrl-checkboxgroup"); o.empty(), $(t.options.split("\n")).each(function (e, i) { var l = $(n).clone().text($.trim(i)), r = $(a).clone(); r[0].name = t.code, r[0].value = $.trim(i), l.prepend(r), $(o).append(l) }) }, t.selectmultiplelist = function (e) { t.combobox(e) }, t.radiogroup = function (t) { var e = $("#" + t.forCtrl), n = $(".selectorField .ctrl-radiogroup span")[0], a = $(".selectorField .ctrl-radiogroup input")[0], o = e.find(".ctrl-radiogroup"); o.empty(), $(t.options.split("\n")).each(function (e, i) { var l = $(n).clone().text($.trim(i)), r = $(a).clone(); r[0].name = t.code, r[0].value = $.trim(i), l.prepend(r), $(o).append(l) }) }, t.btn = function (t) { var e = $("#" + t.forCtrl), n = e.find("button")[0]; $(n).html($(n).html().replace($(n).text(), " " + $.trim(t.title))), n.name = t.code }, t.text = function (t) { var e = $("#" + t.forCtrl), n = e.find(".ctrl-text"); n.text(t.text), n.attr("name", t.code) }, t.date = function (t) { var e = $("#" + t.forCtrl), n = e.find(".ctrl-date"); n.attr("name", t.code) }, t.simpletext = function (t, e, n) { var a = $("#" + t.forCtrl), o = a.find(e); o.text(n) }, t }(), tableManager = function () { function t() { } return t.appendTable = function () { var t = !0; if (t) { for (var e = $("#sliderNumberColumn").slider("value"), n = '<div class="row-fluid">', a = 12 / e, o = 0; e > o; o++) n += '<div class="span' + a + ' well droppedFields"></div>\n'; n += "</div>", $("#dialog-form-number-column").modal("hide"), $("#selected-content").append(n), kmaster.docReady() } }, t }(), eavManager = function () { function t() { } return t.EntityDef = {}, t.Attributes = [], t.saveEntityDef = function () { var t = {}; if ($("#defForm").find("input").each(function (e, n) { t[n.name] = n.value }), "" == t.title || "" == t.name) return void $.msgBox({ title: "Master / Entity", content: "表单信息不完整，请输入表单标题等基本信息再点击保存！", type: "info" }); var e = {}; if (e.ID = kmaster.mcurrentEntityDefID, e.EntityTitle = t.label, e.EntityName = t.name, e.Description = t.desc, 0 == e.ID) { var n = '<div class="span12 ui-sortable" id="selected-content"><div class="row-fluid" id="form-title-div"><input value=' + e.EntityTitle + ' class="input-large span12" placeholder="请输入表单标题..." id="txtFormTitle" onclick="kmaster.popupEntityDef();" type="text"></div><div class="row-fluid"><div class="span6 well droppedFields ui-droppable"></div><div class="span6 well droppedFields ui-droppable"></div></div><div class="row-fluid"><div class="span12 well action-bar droppedFields ui-droppable" style="min-height:80px;"></div></div></div>', a = '<div class="row-fluid"><div class="span6 droppedFields"></div><div class="span6 droppedFields"></div></div><div class="row-fluid"><div class="span12 action-bar droppedFields" style="min-height:80px;"></div></div>'; e.TemplateContent = n, e.HTMLContent = a } jshelper.ajaxPost("/smd/api/eavdata/SaveEntityDef", JSON.stringify(e), function (t) { if (1 == t.Status) { $.msgBox({ title: "Master / Entity", content: "表单记录已经成功保存！", type: "info" }); var e = t.Entity; kmaster.mcurrentEntityDefID = e.ID, $("#txtFormTitle").attr("value", e.EntityTitle), $("#selected-content").replaceWith(e.TemplateContent), kmaster.docReady() } else $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) }, t.SaveTemplateWithHTMLContent = function () { var t = $("#selected-content")[0].outerHTML, e = kmaster.generateHTMLContent(), n = { ID: kmaster.mcurrentEntityDefID, TemplateContent: t, HTMLContent: e }; jshelper.ajaxPost("/smd/api/eavdata/SaveTemplateWithHTMLContent", JSON.stringify(n), function (t) { 1 == t.Status ? $.msgBox({ title: "Master / Entity", content: "表单模板已经成功保存！", type: "info" }) : $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) }, t.saveAttribute = function (t) { jshelper.ajaxPost("/smd/api/eavdata/SaveAttribute", JSON.stringify(t), function (t) { 1 == t.Status ? $.msgBox({ title: "Master / Attribute", content: "属性记录已经成功保存！", type: "info" }) : $.msgBox({ title: "Ooops", content: t.Message, type: "error", buttons: [{ value: "Ok" }] }) }) }, t }();